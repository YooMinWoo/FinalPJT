<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >  

<mapper namespace="superPms.dao.Notice_Dao">

	<!-- 검색 데이터 가져오기, 페이징 처리 O -->
	<select id="noticeList" parameterType="noticesch" resultType="notice">
		select * from(
			SELECT rownum cnt, 
				noticeno,
				refno,
				to_char(n.regdte,'yyyy-mm-dd') regdte,
				to_char(n.uptdte,'yyyy-mm-dd') uptdte,
				title,
				content,
				viewcnt,
				writer,
				n.fno,
				deptid,
				fname
			FROM (SELECT * FROM notice ORDER BY UPTDTE DESC) n, files f
			where n.fno=f.fno(+)
			AND (deptid like '%'||#{schInfo}||'%'
			or title like '%'||#{schInfo}||'%')
		)
		where cnt between #{start} and #{end}
	</select>
	
	<!-- 페이지 상세조회 -->
	<select id="noticeDetail" parameterType="notice" resultType="notice">
		SELECT rownum, 
			noticeno,
			refno,
			to_char(n.regdte,'yyyy-mm-dd') regdte,
			to_char(n.uptdte,'yyyy-mm-dd') uptdte,
			title,
			content,
			viewcnt,
			writer,
			n.fno,
			deptid,
			fname
		FROM (SELECT * FROM notice ORDER BY UPTDTE DESC) n, files f
		where n.fno=f.fno(+)
		and noticeno=#{noticeno}
	</select>
	
	<!-- 공지사항 업데이트 처리 -->
	<update id="uptNotice" parameterType="notice">
		<if test= "fname != null and !fname.equals('')">
			update notice
			set
				title=#{title},
				content=#{content},
				uptdte = sysdate,
				fno=files_seq.currval
			where noticeno=#{noticeno}
		</if>
		<if test= "fname == null or fname.equals('')">
			update notice
			set
				title=#{title},
				content=#{content},
				uptdte = sysdate
			where noticeno=#{noticeno}
		</if>
	</update>
	
	<!-- 조회수 +1 처리 -->
	<update id="plusCnt" parameterType="notice">
		update notice
		set
			viewcnt = viewcnt+1
		where noticeno=#{noticeno}
	</update>
	
	<!-- 파일DB에 insert -> 공지사항 등록시, 파일이 있을 경우 파일 insert -->
	<insert id="insertFile" parameterType="notice">
		insert into files values(
			files_seq.nextval,#{fname},sysdate,sysdate,#{path}
		)
	</insert>
	
	<!-- 공지사항 등록, 파일 유무 확인 -->
	<insert id="insertNotice" parameterType="notice">
		<if test= "fname != null and !fname.equals('')">
			insert into notice values(
				notice_seq.nextval,0,sysdate,sysdate,#{title},#{content},0,#{writer},
				files_seq.currval,#{deptid}
			)
		</if>
		<if test= "fname == null or fname.equals('')">
			insert into notice values(
				notice_seq.nextval,0,sysdate,sysdate,#{title},#{content},0,#{writer},
				'',#{deptid}
			)
		</if>
	</insert>
	
	<!-- 페이징 처리를 위한 전체 데이터 가져오기 -->
	<select id="totCnt" parameterType="noticesch" resultType="int">
			select count(*)
		      from notice
		      where 1=1
		      and deptid like '%'||#{schInfo}||'%'
		      and title like '%'||#{schInfo}||'%'
	</select>
</mapper>